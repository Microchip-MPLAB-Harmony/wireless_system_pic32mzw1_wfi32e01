<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="../../../assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2724382-16"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2724382-16'); </script> <script type="text/javascript" src="../../../assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="../../../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>MQTT System Service Developer’s Guide | Microchip MPLAB Harmony PIC32MZW1 wireless system services help</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="MQTT System Service Developer’s Guide" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Harmony 3 PIC32MZW1/WFI32 wireless system services" /> <meta property="og:description" content="Harmony 3 PIC32MZW1/WFI32 wireless system services" /> <link rel="canonical" href="../../../system/mqtt/docs/developer.html" /> <meta property="og:url" content="../../../system/mqtt/docs/developer.html" /> <meta property="og:site_name" content="Microchip MPLAB Harmony PIC32MZW1 wireless system services help" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="MQTT System Service Developer’s Guide" /> <script type="application/ld+json"> {"@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"../../assets/images/vendor/microchip_mplab_harmony_logo_150_transparent.png"}},"url":"../../../system/mqtt/docs/developer.html","headline":"MQTT System Service Developer’s Guide","description":"Harmony 3 PIC32MZW1/WFI32 wireless system services","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="../../../index.html" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../index.html" class="nav-list-link">Harmony 3 PIC32MZW1 wireless system services package</a><ul class="nav-list "><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/wifi/docs/readme.html" class="nav-list-link">Wi-Fi Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/wifi/docs/configuration.html" class="nav-list-link">Wi-Fi System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/wifi/docs/developer_guide.html" class="nav-list-link">Wi-Fi System Service developer guide</a> </li><li class="nav-list-item "> <a href="../../../system/wifi/docs/usage.html" class="nav-list-link">Wi-Fi System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/wifi/docs/interface.html" class="nav-list-link">Wi-Fi System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/wss/docs/readme.html" class="nav-list-link">Web Socket Server System Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/wss/docs/developer.html" class="nav-list-link">Web Socket System Service Developer's Guide</a> </li><li class="nav-list-item "> <a href="../../../system/wss/docs/usage.html" class="nav-list-link">Web Socket Server System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/wss/docs/interface.html" class="nav-list-link">Web Socket Server System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/appdebug/docs/readme.html" class="nav-list-link">App Debug Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/appdebug/docs/configuration.html" class="nav-list-link">App Debug System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/appdebug/docs/usage.html" class="nav-list-link">App Debug System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/appdebug/docs/interface.html" class="nav-list-link">App Debug System Service Interface</a> </li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/mqtt/docs/readme.html" class="nav-list-link">MQTT Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/mqtt/docs/configuration.html" class="nav-list-link">MQTT System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/mqtt/docs/usage.html" class="nav-list-link">MQTT System Service Usage</a> </li><li class="nav-list-item active"> <a href="../../../system/mqtt/docs/developer.html" class="nav-list-link active">MQTT System Service Developer's Guide</a> </li><li class="nav-list-item "> <a href="../../../system/mqtt/docs/interface.html" class="nav-list-link">MQTT System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/net/docs/readme.html" class="nav-list-link">Net Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/net/docs/configuration.html" class="nav-list-link">Net System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/net/docs/developer.html" class="nav-list-link">Net System Service Developer's Guide</a> </li><li class="nav-list-item "> <a href="../../../system/net/docs/usage.html" class="nav-list-link">Net System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/net/docs/interface.html" class="nav-list-link">Net System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/wifiprov/docs/readme.html" class="nav-list-link">Wi-Fi provisioning Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/wifiprov/docs/configuration.html" class="nav-list-link">Wi-Fi provisioning System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/wifiprov/docs/developer_guide.html" class="nav-list-link">Wi-Fi provisioning System Service developer guide</a> </li><li class="nav-list-item "> <a href="../../../system/wifiprov/docs/usage.html" class="nav-list-link">Wi-Fi provisioning System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/wifiprov/docs/interface.html" class="nav-list-link">Wi-Fi provisioning System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/ota/docs/readme.html" class="nav-list-link">OTA Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/ota/docs/configuration.html" class="nav-list-link">OTA System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/ota/docs/usage.html" class="nav-list-link">OTA System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/ota/docs/developer_guide.html" class="nav-list-link">OTA System Developer's guide</a> </li><li class="nav-list-item "> <a href="../../../system/ota/docs/interface.html" class="nav-list-link">OTA System Service Interface</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="../../../release_notes.html" class="nav-list-link">Release notes</a></li><li class="nav-list-item"><a href="../../../mplab_harmony_license.html" class="nav-list-link">License</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Microchip MPLAB Harmony PIC32MZW1 wireless system services help" aria-label="Search Microchip MPLAB Harmony PIC32MZW1 wireless system services help" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://support.microchip.com" class="site-button" > Obtain Support from Microchip </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="../../../index.html">Harmony 3 PIC32MZW1 wireless system services package</a></li> <li class="breadcrumb-nav-list-item"><a href="../../../system/mqtt/docs/readme.html">MQTT Service</a></li> <li class="breadcrumb-nav-list-item"><span>MQTT System Service Developer's Guide</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="mqtt-system-service-developers-guide"> <a href="#mqtt-system-service-developers-guide" aria-labelledby="mqtt-system-service-developers-guide" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> MQTT System Service Developer’s Guide </h1> <h3 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" aria-labelledby="table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h3> <ol id="markdown-toc"> <li><a href="#overview" id="markdown-toc-overview">Overview</a></li> <li><a href="#detailed-design" id="markdown-toc-detailed-design">Detailed Design</a> <ol> <li><a href="#state-machine" id="markdown-toc-state-machine">State Machine</a> <ol> <li><a href="#mqtt-client-state-machine" id="markdown-toc-mqtt-client-state-machine">MQTT Client State Machine</a></li> </ol> </li> <li><a href="#number-of-subscription-topics-supported" id="markdown-toc-number-of-subscription-topics-supported">Number of Subscription Topics Supported</a></li> <li><a href="#timeperiod-for-ack" id="markdown-toc-timeperiod-for-ack">Timeperiod for ACK</a></li> <li><a href="#external-apis" id="markdown-toc-external-apis">External APIs</a> <ol> <li><a href="#sys_mqtt_connect-" id="markdown-toc-sys_mqtt_connect-">SYS_MQTT_Connect ()</a></li> <li><a href="#sys_mqtt_disconnect-" id="markdown-toc-sys_mqtt_disconnect-">SYS_MQTT_Disconnect ()</a></li> <li><a href="#sys_mqtt_publish-" id="markdown-toc-sys_mqtt_publish-">SYS_MQTT_Publish ()</a></li> <li><a href="#sys_mqtt_subscribe-" id="markdown-toc-sys_mqtt_subscribe-">SYS_MQTT_Subscribe ()</a></li> <li><a href="#sys_mqtt_unsubscribe-" id="markdown-toc-sys_mqtt_unsubscribe-">SYS_MQTT_Unsubscribe ()</a></li> <li><a href="#handling-of-the-messages-received-for-a-topic" id="markdown-toc-handling-of-the-messages-received-for-a-topic">Handling of the messages received for a Topic</a></li> <li><a href="#handling-of-keepalive-messages-after-the-mqtt-connection-is-up" id="markdown-toc-handling-of-keepalive-messages-after-the-mqtt-connection-is-up">Handling of KeepAlive messages after the MQTT connection is UP</a></li> <li><a href="#sys_mqtt_task-" id="markdown-toc-sys_mqtt_task-">SYS_MQTT_Task ()</a></li> <li><a href="#sys_mqtt_initialize--sys_mqtt_deinitialize-" id="markdown-toc-sys_mqtt_initialize--sys_mqtt_deinitialize-">SYS_MQTT_Initialize ()/ SYS_MQTT_Deinitialize ()</a></li> </ol> </li> <li><a href="#cli-commands" id="markdown-toc-cli-commands">CLI Commands</a></li> <li><a href="#code-location" id="markdown-toc-code-location">Code location</a></li> </ol> </li> <li><a href="#reference" id="markdown-toc-reference">Reference</a></li> </ol> <hr /> <p>The purpose of this document is to explain the MQTT system service design to enable the developer to make changes in the service code as per his/ her requirements if the need be.</p> <h1 id="overview"> <a href="#overview" aria-labelledby="overview" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview </h1> <p>MQTT system service Library provides an application programming interface (API) to manage MQTT Protocol functionalities. The MQTT system service uses the third party software Paho APIs for achieving these functionalities. It supports key features like client mode for MQTT connectivity, TLS for MQTT connection, Self-Healing, etc.</p> <p align="center"> <img src="./images/Stack.png" style="width:2.70833in;height:3.53125in" /> </p> <p>Though the application developer is free to use the third party software directly to manage the MQTT functionalities, the use of MQTT system service eases the work of the developer by reducing the state machine that the application needs to maintain while also reducing the amount of bookkeeping that otherwise is needed.</p> <h1 id="detailed-design"> <a href="#detailed-design" aria-labelledby="detailed-design" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Detailed Design </h1> <p>MQTT system service is a background service that runs in the context of the application task. The idea of the MQTT system service is to reduce the code size for the application and simplifying the state machine that the application may need to maintain by abstracting out the complexity in the system service. The system service achieves this by maintaining a state machine of its own and any bookkeeping that may be needed.</p> <p>The MQTT system service supports only client mode. Also, the service supports secured connections for its MQTT connection with the server.</p> <p>The MQTT system service also supports Self-Healing, or ‘Auto-Reconnect’. In case there is an interruption in the connection due to the underlying lower layer or when the peer disconnects, the service tries to reconnect again without making the application to bother about retriggering the connection.</p> <h2 id="state-machine"> <a href="#state-machine" aria-labelledby="state-machine" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> State Machine </h2> <p>The various states of the MQTT system service are of the enum type <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_status"><em>SYS_MQTT_STATUS</em></a>. The application is expected to call <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_task"><em>SYS_MQTT_Task()</em></a>periodically from its own task context. This function ensures that the MQTT system service state machine receives sufficient execution cycles to process pending packets in the network stack.</p> <h3 id="mqtt-client-state-machine"> <a href="#mqtt-client-state-machine" aria-labelledby="mqtt-client-state-machine" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> MQTT Client State Machine </h3> <p>The MQTT system service runs a finite state machine with the following states:</p> <ol> <li> <p><em>SYS_MQTT_STATUS_IDLE</em>: Initial State of the MQTT system service, at the initialization.</p> </li> <li> <p><em>SYS_MQTT_STATUS_LOWER_LAYER_DOWN</em>:</p> <ol> <li> <p>State the MQTT system service enters after initialization.</p> </li> <li> <p>In this state, the MQTT system service opens the TCP socket using NET system service without bothering if the lower layer is UP or DOWN. This offloads the application’s burden to poll the link before communicating over the network.</p> </li> </ol> </li> <li> <p><em>SYS_MQTT_STATUS_SOCK_CLIENT_CONNECTING</em>: In this state, the service opens a socket to connect to the MQTT server using NET system service, and waits for the connection to get established.</p> </li> <li> <p><em>SYS_MQTT_STATUS_SOCK_CONNECTED</em>: TCP connection between the client the MQTT server established; client triggers MQTT ‘Connect’ to the server via the Paho APIs.</p> </li> <li> <p><em>SYS_MQTT_STATUS_SOCK_OPEN_FAILED</em>: Opening the Socket failed. Failure is conveyed to the application via the <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_callback">callback</a> registered with the service.</p> </li> <li> <p><em>SYS_MQTT_STATUS_MQTT_CONNECTED</em>: Client connected to the MQTT server; Connection status is conveyed to the application via the registered callback. In this state, the service is waiting to receive data on topic(s).</p> </li> <li> <p><em>SYS_MQTT_STATUS_MQTT_DISCONNECTING</em>: Client comes into this state whenever there is either of the following:</p> <ol> <li> <p>A failure to connect to the server (tcp or mqtt connection), or</p> </li> <li> <p>Timeout occurs on not receiving expected response, or</p> </li> <li> <p>Failure in case of publishing a message or subscribing to a topic. In this state, the client reinitializes the data w.r.t subscriptions topics.</p> </li> <li> <p>Paho API to connect to MQTT server failed.</p> </li> </ol> </li> <li> <p><em>SYS_MQTT_STATUS_MQTT_DISCONNECTED</em>: Client disconnected from the server. ‘Disconnection’ is conveyed to the application via the registered callback.</p> </li> <li> <p><em>SYS_MQTT_STATUS_WAIT_FOR_MQTT_CONACK</em>: Client waits for the reply ‘CONACK’ from the MQTT server in response to his ‘CONNECT’ message, for SYS_MQTT_PERIOIDC_TIMEOUT seconds.</p> </li> <li> <p><em>SYS_MQTT_STATUS_WAIT_FOR_MQTT_SUBACK</em>: Client waits for the reply ‘SUBACK’ from the MQTT server in response to his ‘SUBSCRIBE’ message, for SYS_MQTT_PERIOIDC_TIMEOUT seconds.</p> </li> <li> <p><em>SYS_MQTT_STATUS_WAIT_FOR_MQTT_PUBACK</em>: Client waits for the reply ‘PUBACK’ from the MQTT server in response to his ‘PUBLISH’ message in case it was sent with Qos as 1 or 2, for SYS_MQTT_PERIOIDC_TIMEOUT seconds.</p> </li> <li> <p><em>SYS_MQTT_STATUS_WAIT_FOR_MQTT_UNSUBACK</em>: Client waits for the reply ‘UNSUBACK’ from the MQTT server in response to his ‘UNSUBSCRIBE’ message, for SYS_MQTT_PERIOIDC_TIMEOUT seconds.</p> </li> </ol> <p align="center"> <img src="./images/StateMachine.png" style="width:6.5in;height:6.73958in" /> </p> <p>The above state machine has been implemented in the function <em>SYS_MQTT_Paho_Task().</em> The statme machine figure has been broken into two, so as to make it simpler to understand, and hence both the above state machine figures should be seen in conjection.</p> <p><strong>In case the user wants to add or remove a state or modify the action to be done in an existing state (for instance, adding a timer for a time-bound result), one would need to modify the function <em>SYS_MQTT_Paho_Task()</em> along with the enum <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_status">SYS_MQTT_STATUS</a><em>.</em></strong></p> <h2 id="number-of-subscription-topics-supported"> <a href="#number-of-subscription-topics-supported" aria-labelledby="number-of-subscription-topics-supported" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Number of Subscription Topics Supported </h2> <p>The number of subscription topics supported by MQTT system service currently is 2. <em>*The same can be increased by changing the value of the macro *SYS_MQTT_SUB_MAX_TOPICS. **</em>Also note, that the underlying third party software Paho supports 5 subscription topics, so if the developer needs to use more than 5 topics, he/ she will need to make changes in the Paho code (<em>MAX_MESSAGE_HANDLERS</em>) too.</p> <h2 id="timeperiod-for-ack"> <a href="#timeperiod-for-ack" aria-labelledby="timeperiod-for-ack" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Timeperiod for ACK </h2> <p>The number of seconds the MQTT system service will wait for the ACK to come – CONACK, or SUBACK, or PUBACK, or UNSUBACK is currently 5 seconds. The developer can increase or decrease this time by modifying the value of SYS_MQTT_PERIOIDC_TIMEOUT.</p> <h2 id="external-apis"> <a href="#external-apis" aria-labelledby="external-apis" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> External APIs </h2> <h3 id="sys_mqtt_connect-"> <a href="#sys_mqtt_connect-" aria-labelledby="sys_mqtt_connect-" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_connect">SYS_MQTT_Connect ()</a> </h3> <p>Description: The API is used for connecting an MQTT client to the server. The user needs to register a callback function via this API. The registered callback lets the user know the operational status change or when data is received on the topic subscribed to. One of the advantages of this API is that the user can call this API without bothering about the operational state of the underlying layers, and the service shall take care of all the complexity in such cases.</p> <p align="center"> <img src="./images/SYS_MQTT_Connect.png" style="width:7.08056in;height:6.87387in" /> </p> <h3 id="sys_mqtt_disconnect-"> <a href="#sys_mqtt_disconnect-" aria-labelledby="sys_mqtt_disconnect-" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_disconnect">SYS_MQTT_Disconnect ()</a> </h3> <p>Description: The API is used for disconnecting the MQTT client from the server.</p> <p align="center"> <img src="./images/SYS_MQTT_Disconnect.png" style="width:6.49653in;height:2.15903in" /> </p> <h3 id="sys_mqtt_publish-"> <a href="#sys_mqtt_publish-" aria-labelledby="sys_mqtt_publish-" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_publish">SYS_MQTT_Publish ()</a> </h3> <p>Description: The API is used for publishing a message onto a topic.</p> <p align="center"> <img src="./images/SYS_MQTT_Publish.png" style="width:6.49583in;height:4.41458in" /> </p> <h3 id="sys_mqtt_subscribe-"> <a href="#sys_mqtt_subscribe-" aria-labelledby="sys_mqtt_subscribe-" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_subscribe">SYS_MQTT_Subscribe ()</a> </h3> <p>Description: The API is used for subscribing to a topic.</p> <p align="center"> <img src="./images/SYS_MQTT_Subscribe.png" style="width:6.49583in;height:4.27917in" /> </p> <h3 id="sys_mqtt_unsubscribe-"> <a href="#sys_mqtt_unsubscribe-" aria-labelledby="sys_mqtt_unsubscribe-" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_unsubscribe">SYS_MQTT_Unsubscribe ()</a> </h3> <p>Description: The API is used for unsubscribing from a topic.</p> <p align="center"> <img src="./images/SYS_MQTT_Unsubscribe.png" style="width:6.49583in;height:4.05417in" /> </p> <h3 id="handling-of-the-messages-received-for-a-topic"> <a href="#handling-of-the-messages-received-for-a-topic" aria-labelledby="handling-of-the-messages-received-for-a-topic" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling of the messages received for a Topic </h3> <p align="center"> <img src="./images/ReceiveMsgOnTopic.png" style="width:6.49028in;height:3.03333in" /> </p> <h3 id="handling-of-keepalive-messages-after-the-mqtt-connection-is-up"> <a href="#handling-of-keepalive-messages-after-the-mqtt-connection-is-up" aria-labelledby="handling-of-keepalive-messages-after-the-mqtt-connection-is-up" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling of KeepAlive messages after the MQTT connection is UP </h3> <p align="center"> <img src="./images/KeepAlive.png" style="width:6.49028in;height:7.70833in" /> </p> <h3 id="sys_mqtt_task-"> <a href="#sys_mqtt_task-" aria-labelledby="sys_mqtt_task-" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_task">SYS_MQTT_Task ()</a> </h3> <p>Description: This API is used for smooth functioning of the state machine of the MQTT system service<strong>.</strong> The application needs to call this API periodically. Also, this API takes as parameter the handle returned when we connect to server via the SYS_MQTT_Connect() call.</p> <h3 id="sys_mqtt_initialize--sys_mqtt_deinitialize-"> <a href="#sys_mqtt_initialize--sys_mqtt_deinitialize-" aria-labelledby="sys_mqtt_initialize--sys_mqtt_deinitialize-" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_initialize">SYS_MQTT_Initialize ()</a>/ <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html#sys_mqtt_deinitialize">SYS_MQTT_Deinitialize ()</a> </h3> <p>Description: These functions are used for initializing/ deinitializing the data structures of the MQTT system service. The SYS_MQTT_Initialize() function is called from within the System Task. <strong>Users can modify these functions in case they want to take some additional actions during the initialization of the service.</strong></p> <h2 id="cli-commands"> <a href="#cli-commands" aria-labelledby="cli-commands" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CLI Commands </h2> <p>The details of the cli commands supported by MQTT system service can be found <a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/usage.html">here</a>. The CLI commands are implemented using the function <em>SysMqtt_Command_Process()</em>. <strong>The users can modify any of the commands – configuration or get as per their needs by modifying the above function.</strong></p> <h2 id="code-location"> <a href="#code-location" aria-labelledby="code-location" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code location </h2> <p>The base code for the MQTT system service can be found in the <em>wireless_system_pic32mzw1_wfi32e01\system\mqtt</em></p> <p>The same shall be copied to the following location after the code for the application is generated – <em>my_application\firmware\src\config\pic32mz_w1_curiosity\system\mqtt</em></p> <p>The code has 4 files:</p> <ol> <li> <p>Header file: <em>sys_mqtt.h</em> and <em>sys_paho_mqtt.h</em></p> </li> <li> <p>Source file: <em>src/sys_mqtt.c</em> and <em>src/sys_paho_mqtt.c</em></p> </li> </ol> <p>Since the above files could see modifications across releases, hence the users would need to take care of merging the changes they did in these files with the ones which were done in the new release by Microchip Team. For this the user needs to take care of this while generating the code via the MHC:</p> <p align="center"> <img src="./images/MhcMergeStrategy.png" style="width:6.5in;height:6.67639in" /> </p> <p>While generating the code the user should use the Merge Strategy as “USER_ALL”, and press “Generate”. In case there are changes done by user in any of the files, the MHC shall prompt the user about it:</p> <p align="center"> <img src="./images/MhcMergeWindow.png" style="width:6.5in;height:3.16528in" /> </p> <p>The user can merge his changes with the the latest changes done in the services using the above window.</p> <h1 id="reference"> <a href="#reference" aria-labelledby="reference" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Reference </h1> <div class="table-wrapper"><table> <thead> <tr> <th>S. No</th> <th>Name</th> <th>Link</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>MQTT system service Usage</td> <td><a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/usage.html">https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/usage.html</a></td> </tr> <tr> <td>2</td> <td>MQTT system service Interface</td> <td><a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html">https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/mqtt/docs/interface.html</a></td> </tr> <tr> <td>3</td> <td>NET system service Interface</td> <td><a href="https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/net/docs/interface.html">https://microchip-mplab-harmony.github.io/wireless_system_pic32mzw1_wfi32e01/docs/system/net/docs/interface.html</a></td> </tr> </tbody> </table></div> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0"><img src='https://raw.githubusercontent.com/wiki/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/images/microchip_logo.png' /><br />Copyright &copy; 2020 Microchip Technology.</p> <!-- <p class="text-small text-grey-dk-000 mb-0"><img src='../../../assets/images/vendor/microchip_logo.png' /><br /> Copyright &copy; 2022 Microchip Technology.</p> --> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
