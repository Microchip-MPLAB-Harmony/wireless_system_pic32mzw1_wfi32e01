<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="../../../favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="../../../assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2724382-16"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2724382-16'); </script> <script type="text/javascript" src="../../../assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="../../../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>OTA System Service Usage | Microchip MPLAB Harmony PIC32MZW1 wireless system services help</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="OTA System Service Usage" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Harmony 3 PIC32MZW1/WFI32 wireless system services" /> <meta property="og:description" content="Harmony 3 PIC32MZW1/WFI32 wireless system services" /> <link rel="canonical" href="../../../system/ota/docs/usage.html" /> <meta property="og:url" content="../../../system/ota/docs/usage.html" /> <meta property="og:site_name" content="Microchip MPLAB Harmony PIC32MZW1 wireless system services help" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="OTA System Service Usage" /> <script type="application/ld+json"> {"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"../../assets/images/vendor/microchip_mplab_harmony_logo_150_transparent.png"}},"@type":"WebPage","url":"../../../system/ota/docs/usage.html","headline":"OTA System Service Usage","description":"Harmony 3 PIC32MZW1/WFI32 wireless system services","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="../../../index.html" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../" class="nav-list-link">Harmony 3 PIC32MZW1 wireless system services package</a><ul class="nav-list "><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/wifiprov/docs/readme.html" class="nav-list-link">Wi-Fi provisioning Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/wifiprov/docs/configuration.html" class="nav-list-link">Wi-Fi provisioning System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/wifiprov/docs/developer_guide.html" class="nav-list-link">Wi-Fi provisioning System Service developer guide</a> </li><li class="nav-list-item "> <a href="../../../system/wifiprov/docs/usage.html" class="nav-list-link">Wi-Fi provisioning System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/wifiprov/docs/interface.html" class="nav-list-link">Wi-Fi provisioning System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/mqtt/docs/readme.html" class="nav-list-link">MQTT Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/mqtt/docs/configuration.html" class="nav-list-link">MQTT System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/mqtt/docs/usage.html" class="nav-list-link">MQTT System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/mqtt/docs/interface.html" class="nav-list-link">MQTT System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/net/docs/readme.html" class="nav-list-link">Net Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/net/docs/configuration.html" class="nav-list-link">Net System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/net/docs/usage.html" class="nav-list-link">Net System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/net/docs/interface.html" class="nav-list-link">Net System Service Interface</a> </li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/ota/docs/readme.html" class="nav-list-link">OTA Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/ota/docs/configuration.html" class="nav-list-link">OTA System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/ota/docs/developer_guide.html" class="nav-list-link">OTA System Developer's guide</a> </li><li class="nav-list-item active"> <a href="../../../system/ota/docs/usage.html" class="nav-list-link active">OTA System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/ota/docs/interface.html" class="nav-list-link">OTA System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/appdebug/docs/readme.html" class="nav-list-link">App Debug Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/appdebug/docs/configuration.html" class="nav-list-link">App Debug System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/appdebug/docs/usage.html" class="nav-list-link">App Debug System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/appdebug/docs/interface.html" class="nav-list-link">App Debug System Service Interface</a> </li></ul></li><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../system/wifi/docs/readme.html" class="nav-list-link">Wi-Fi Service</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../../system/wifi/docs/configuration.html" class="nav-list-link">Wi-Fi System Service Configuration</a> </li><li class="nav-list-item "> <a href="../../../system/wifi/docs/developer_guide.html" class="nav-list-link">Wi-Fi System Service developer guide</a> </li><li class="nav-list-item "> <a href="../../../system/wifi/docs/usage.html" class="nav-list-link">Wi-Fi System Service Usage</a> </li><li class="nav-list-item "> <a href="../../../system/wifi/docs/interface.html" class="nav-list-link">Wi-Fi System Service Interface</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="../../../release_notes.html" class="nav-list-link">Release notes</a></li><li class="nav-list-item"><a href="../../../mplab_harmony_license.html" class="nav-list-link">License</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Microchip MPLAB Harmony PIC32MZW1 wireless system services help" aria-label="Search Microchip MPLAB Harmony PIC32MZW1 wireless system services help" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://support.microchip.com" class="site-button" > Obtain Support from Microchip </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="../../../">Harmony 3 PIC32MZW1 wireless system services package</a></li> <li class="breadcrumb-nav-list-item"><a href="../../../system/ota/docs/readme.html">OTA Service</a></li> <li class="breadcrumb-nav-list-item"><span>OTA System Service Usage</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="ota-system-service-usage"> <a href="#ota-system-service-usage" aria-labelledby="ota-system-service-usage" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> OTA System Service Usage </h1> <h2 id="description"> <a href="#description" aria-labelledby="description" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Description </h2> <p>The OTA System Service provides simple APIs to enable Over the Air system firmware image upgrade. While using the service, the application does not have to handle low level states of a TCP/IP Connection, periodic update check triggers, file integrity checks etc. since the service internally takes care of that. The user also does not required extensive Security domain knowledge to establish a secured connection via the application using OTA System Service library.</p> <p>The user would need to configure the Home AP credentials (like SSID and security items). The Wi-Fi service will use the credentials to connect to the Home AP and acquire an IP address. Once the IP address is obtained OTA service will perform OTA update process based on user configuration in MHC.</p> <p><img src="../../../system/ota/docs/images/wifi_sta_http_server_1.png" alt="" /></p> <p>The service state-machine will try to connect with a pre-defined OTA manifest server address and download the new image when a version higher than the version being currently executed is identified. The downloaded image will be stored in the external SPI flash initially. Upon reset, the image will be transferred to the internal flash (NVM) by the OTA bootloader. Once the image is successfully programmed, the updated image from the server will be executed.</p> <p>The OTA service has two major components:</p> <ol> <li>The OTA service task state-machine that will be integrated into the customer application. This task is responsible for polling for an update image, downloading and verifying an image when an update is detected, and resetting the system to apply the newly downloaded image.</li> <li>The OTA bootloader that is responsible for identifying the presence of an updated image in the external flash filesystem and transferring it to the program flash memory (NVM).</li> </ol> <p>A <code class="language-plaintext highlighter-rouge">factory image</code> is a unified application image that contains the bootloader and the application in a single file that can be programmed into the device using an external programmer. To create a factory image, it is required to load the <code class="language-plaintext highlighter-rouge">ota_bootloader</code> project located in the <code class="language-plaintext highlighter-rouge">apps</code> folder of <code class="language-plaintext highlighter-rouge">wireless_apps_pic32mzw1_wfi32e01</code> repo into the application project. A unified hex file will be created at the end of the compilation process. Internally, this step uses the <code class="language-plaintext highlighter-rouge">Hexmate</code> tool after compiling the application project and the bootloader project independently. More details about this can be found in <a href="../../../system/ota/docs/configuration.html#configuring-the-library">Configuring the library</a> section of this manual.</p> <p>OTA service uses the file system component from MHC (MPLAB® Harmony Configurator) and is configured to use an external SPI flash by default. However, this can be modified to use a different medium without major changes since the OTA service uses the file system abstraction to talk to the external storage medium.</p> <p>An OTA image database is maintained by the service in the filesystem. It contains details about the downloaded images (image name, image status,image version, digest key), which will be used by bootloader and OTA service</p> <p><img src="../../../system/ota/docs/images/SPI_com.png" alt="" /></p> <h2 id="ota-service-framework-architecture-overview"> <a href="#ota-service-framework-architecture-overview" aria-labelledby="ota-service-framework-architecture-overview" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> OTA Service Framework Architecture Overview </h2> <p>Over the Air (OTA) firmware upgrade feature is designed with a two step process, Image Downloading and Image Programming process.</p> <ul> <li>Image Downloading is processed by the OTA service.</li> <li>Image Programming is processed by the OTA bootloader.</li> </ul> <p><strong>OTA service</strong> is a Harmony component which includes the system level logic implementation and uses <code class="language-plaintext highlighter-rouge">OTA core</code> APIs. This harmony component will provide some user configurable parameters, based on which service level code will be generated with the corresponding logic. Please follow <code class="language-plaintext highlighter-rouge">Figure-1</code> and <code class="language-plaintext highlighter-rouge">Figure-2</code> for better understanding of this flow.</p> <p><img src="../../../system/ota/docs/images/system_layers.png" alt="" /></p> <p><img src="../../../system/ota/docs/images/top_to_bottom_layers.png" alt="" /></p> <h2 id="abstraction-model"> <a href="#abstraction-model" aria-labelledby="abstraction-model" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Abstraction model: </h2> <p><img src="images/abstraction_model.png" alt="abstractionmodel" /></p> <p><strong>User Application:</strong> This is where the customer application logic is built.</p> <p><strong>OTA Service:</strong> This layer includes the service level logic implementation. This is a Harmony component which provides certain user configurable parameters(ex- Version, Periodic update check etc.) . Based on user configuration, generated code will be activated with required functionalities.</p> <p><img src="../../../system/ota/docs/images/ota_service_component.png" alt="" /></p> <p><img src="images/ota_service_conf.png" alt="" /></p> <p><strong>OTA software platform / OTA Core :</strong> This is the platform layer that consist of the main OTA logic implementation. When OTA process is triggered , this layer will communicate with the transport layer to connect to OTA server. If new image is available , it will initiate download using transport layer. If successfully downloaded, it will store the new image into the File System .</p> <p><strong>File System :</strong> The architecture is designed to provide flexibility for the customer to choose the storage medium (ex- SST26 SPI flash, SD card, USB MSD in host mode etc.). Any medium supported by the Harmony3 file system can be used with the OTA service.</p> <p><strong>Bootloader :</strong> This layer consists of the logic to safely program images from the file system (external) into the program memory (NVM) of the device. At device boot, the bootloader will check if a new image is available in the external image store and transfer it to the NVM.</p> <h2 id="ota-server-json-manifest"> <a href="#ota-server-json-manifest" aria-labelledby="ota-server-json-manifest" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> OTA server JSON manifest </h2> <p>The OTA service expects the HTTP based OTA server to provide metadata of images available in the server in <code class="language-plaintext highlighter-rouge">json</code> format. During periodic update checks, the OTA service task will download and parse this manifest file. Each entry in the manifest file should include the following fields :</p> <ul> <li> <p><strong><code class="language-plaintext highlighter-rouge">Version</code></strong> indicates the application version number. It is a integer value.</p> </li> <li> <p><strong><code class="language-plaintext highlighter-rouge">URL</code></strong> contains the image path from which the application image can be downloaded. It is a string variable.</p> </li> <li> <p><strong><code class="language-plaintext highlighter-rouge">Digest</code></strong> contain the <code class="language-plaintext highlighter-rouge">SHA256</code> digest of image to be downloaded. It is a 64 byte string variable and should not include whitespaces</p> </li> <li> <p><strong><code class="language-plaintext highlighter-rouge">EraseVer</code></strong> This <strong><em>optional</em></strong> field provides a capability to trigger an erase of an version which was downloaded earlier. Customer may want to remove an image from the image store due to various reasons, application with bug, may be one of them. It is a bool variable.</p> <ul> <li> <p>If user configures this field as “true”, OTA service will delete image version mentioned in “Version” field.</p> </li> <li> <p>If user configures this field as “false”, OTA service will follow image downwload logic.</p> </li> </ul> </li> </ul> <p><strong>Sample JSON</strong></p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
    
    </span><span class="nl">"ota"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
                </span><span class="nl">"URL"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://192.168.43.173:8000/wifi_ota103.bin"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"Digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"745189cbb24b752a0175de1f9d5d61433ba47d89aff5b5a3686f54ca2d5dfb22"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"EraseVer"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w">
                </span><span class="nl">"URL"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://192.168.43.173:8000/wifi_ota100.bin"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"Digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"885189cbb24b7b1a0175deef9d5d61f53c247d89a095b5a3686f54ca2d5dfbaa"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"EraseVer"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
            </span><span class="p">}</span><span class="w">
           </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>OTA service will download json file from server first when OTA process is triggered, try to fetch information and proceed further as per below logic:</p> <p><img src="images/json_parse_logic.png" alt="" /></p> <h2 id="factory-image-structure-"> <a href="#factory-image-structure-" aria-labelledby="factory-image-structure-" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Factory Image Structure : </h2> <p>The program memory of an application that include the OTA service will be organized as shown in the image below.</p> <p><img src="../../../system/ota/docs/images/Application_Image3.png" alt="image_structure" /></p> <h3 id="application-header-structure-boot-control-area"> <a href="#application-header-structure-boot-control-area" aria-labelledby="application-header-structure-boot-control-area" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Application Header Structure (boot control area): </h3> <p>A boot control area of size 4 KB is maintained in internal flash area of device as a shared memory between the application and the bootloader. This area will contain fields as shown in figure below.</p> <p><img src="../../../system/ota/docs/images/ota_header.PNG" alt="applicationheader" /></p> <h2 id="image-download-process"> <a href="#image-download-process" aria-labelledby="image-download-process" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Image download process </h2> <ol> <li> <p>The OTA service task identifies that the server manifest includes an image with a version number numerically higher than the current version being executed in the system. Image version number is a C macro that can be defined in MHC.</p> </li> <li> <p>The transport layer starts downloading the image using the link in the URL. If the URL starts with an <code class="language-plaintext highlighter-rouge">https://</code> TLS is automatically used.</p> </li> <li> <p>Once the download is completed successfully, the OTA framework verifies the image by checking the SHA-256 hash, once transport layer finished receiving all data.</p> <p>If download fails, system will go to <code class="language-plaintext highlighter-rouge">IDLE</code>. If <code class="language-plaintext highlighter-rouge">Auto Update</code> is enabled, user need to reset the device to initiate OTA again.</p> </li> <li> <p>If image digest verification is failed, user will be notified using user registered callback.</p> <p>If image digest verification is passed, OTA framework will create an entry in OTA database present in external filesystem. OTA database is maintained in <code class="language-plaintext highlighter-rouge">csv</code> format.</p> <p>Each entry in the OTA database will contain following information:</p> <p><strong>a. image name:</strong> name of downloaded image.</p> <p><strong>b. image status:</strong> This will be set as <strong>0xFE</strong>, for newly downloaded image.</p> <p><strong>c. version number:</strong> Version number of image obtained from JSON manifest.</p> <p><strong>d. image digest:</strong> Image digest obtained from JSON manifest.</p> </li> <li> <p>Once entry is made successfully, OTA framework updates <code class="language-plaintext highlighter-rouge">Boot-Control-header</code>, status field of the current application to “Disabled” 0xF0.</p> </li> </ol> <p>User will be notified about successful OTA process via user registered callback and wait for system reset or trigger auto system reset based on MHC configuration to load new image into the program flash memory.</p> <h2 id="blockflow-diagram"> <a href="#blockflow-diagram" aria-labelledby="blockflow-diagram" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Block/Flow Diagram: </h2> <p><strong>a. OTA Service:</strong></p> <p><img src="images/otaservice_flowchart.PNG" alt="applicationheader" /></p> <ul> <li> <p><strong>OTA Start:</strong> OTA process can be triggered using various methods :</p> <p>Periodically : System will communicate with OTA server periodically (configured by user) to check if any new image is available and initiate OTA process accordingly.</p> <p>Manually : OTA can be triggerred by the application by calling an API.</p> <p>Other sources : User may configure/implement any other means of source like MQTT server to trigger OTA. This is a subset of the manual triggers.</p> </li> <li><strong>Download JSON manifest file and check for version :</strong> JSON file will be downloaded from server first , once OTA process is initiated. JSON file will have version number along with other details. Now system will try to compare the extracted version number from JSON file with currently running application version number and decide accordingly the next step : <ul> <li>If version number is same abort the OTA process because new image is not available.</li> <li>If version number is different and higher than the current application version number, then system will continue with OTA process.</li> </ul> </li> <li> <p><strong>Initiating image Download process :</strong> Based on user configuration system will go for image downloading or will wait for download trigger by user.</p> </li> <li> <p><strong>Digest verify :</strong> SHA-256 verification will be done for downloaded image.</p> </li> <li> <p><strong>Update OTA database file system :</strong> If digest verification is successful , OTA database will be updated in file system for new image.</p> </li> <li> <p><strong>Storing image in the external flash and wait :</strong> If downloaded successfully, the image will be stored in the external flash using standard FS present in Harmony. Afterwards system will perform following steps depending upon user configuration :</p> <ul> <li> <p>reset automatically if Auto reset option is enabled .</p> </li> <li> <p>wait till user application triggers reset.</p> </li> </ul> </li> </ul> <p><strong>b. Image Programming:</strong></p> <p><img src="images/bootloader_flowchart.PNG" alt="" /></p> <ol> <li>During each system boot-up, bootloader checks if it needs to program any new, valid image from the external flash. Bootloader goes to program mode, if- <ol> <li>any newly downloaded image present in the external flash.</li> <li>if the already present image in the program flash is not “validated” during previous boot.</li> </ol> </li> </ol> <p>There are two conditions :</p> <ul> <li> <p>whether the Application Image in Program-Flash area is valid (indicated by the STATUS field, value of 0xF8 in image boot control area of internal flash), and</p> </li> <li> <p>whether it has been confirmed that no errors were present during the previous boot (indicated by the STATUS field of image Database in the external flash, value of 0xF8 ).</p> <p>According to bootloader logic if these two conditions are satisfied it will not go to <code class="language-plaintext highlighter-rouge">Program Mode</code> and the bootloader immediately jumps to the application image present in the program-flash area of the device.</p> </li> </ul> <ol> <li> <p>If two conditions mentioned in the step 1 are not satisfied, the bootloader switches to Image Program Mode. In Image Program Mode bootloader follows Image Programming sequence, which finds the highest ranked image in Image-Store(external flash), erases the Program-Flash area and copies the selected image to the Program-Flash area if the image is successfully verified. As the newly downloaded image with highest version is set as the highest ranked, during the first boot time after the Image-downloading, the bootloader attempts to load the newly downloaded image at the first try.</p> <p>The bootloader choses the highest ranked image to boot. The images are ranked in following order:</p> <ol> <li>The downloaded , valid Image with highest version.</li> <li>The next valid, higher version image.</li> <li> <p>The next known valid, higher version image.</p> <p>.</p> <p>.</p> <p>.</p> </li> <li>Default (Golden/Factory) image.</li> </ol> </li> <li> <p>If the image is not valid, the bootloader invalidates the image by setting “Invalidate” <code class="language-plaintext highlighter-rouge">0xF0</code> in <code class="language-plaintext highlighter-rouge">STATUS</code> field of image in OTA database present in the external flash and restarts the Image-Programming sequence.</p> </li> <li> <p>If image is verified successfully, bootloader updates <code class="language-plaintext highlighter-rouge">STATUS</code> field of boot control area in internal flash as <code class="language-plaintext highlighter-rouge">Unbooted (0xFC)</code></p> </li> </ol> <h2 id="configuration-fuses"> <a href="#configuration-fuses" aria-labelledby="configuration-fuses" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuration fuses </h2> <p>Due to the way configuration fuses are stored in the device, they cannot be modified by the bootloader at runtime. Consequently, when the bootloader loads the application, the config fuses set in the bootloader (using <code class="language-plaintext highlighter-rouge">#pragma</code> in the bootloader code) will be retained.</p> <p>Unlike most of the other PIC32MZ devices, some of the configuration values of PCI32MZW1 / WFI32 can be overridden at runtime. These are marked as loadable configurations in the datasheet. Please refer to the <code class="language-plaintext highlighter-rouge">Configuration Bits</code> section of the <code class="language-plaintext highlighter-rouge">SPECIAL FEATURES</code> chapter of the PIC32MZW1 datasheet to see a list of loadable configurations and how to apply them. These loadable configs can be applied at runtime from the application.</p> <h2 id="generating-the-ota-image"> <a href="#generating-the-ota-image" aria-labelledby="generating-the-ota-image" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generating the OTA image </h2> <p>Images that are downloaded from the server as part of the OTA process should be stored in <code class="language-plaintext highlighter-rouge">.bin</code> format as opposed to the Intel Hex format that is generated by MPLABX.</p> <p>To convert the <code class="language-plaintext highlighter-rouge">hex</code> file to <code class="language-plaintext highlighter-rouge">bin</code> format, you can use the <code class="language-plaintext highlighter-rouge">hex2bin</code> tool in the <code class="language-plaintext highlighter-rouge">tools</code> folder of your project. This folder will be created when you generate MHC code with the OTA service included in your project.</p> <ul> <li> <p>In case of a windows machine, you can execute the command <code class="language-plaintext highlighter-rouge">hex2bin.exe -i &lt;path to hex file in the dist folder&gt;</code>. In case your development environment is based on a non-Windows OS, you can execute the python script with the same arguments. Make sure that you have python3 installed in your machine.</p> <ul> <li>User may execute <code class="language-plaintext highlighter-rouge">hex2bin</code> tool directly from <code class="language-plaintext highlighter-rouge">tools</code> folder without any argument. In that case, tool will search for <code class="language-plaintext highlighter-rouge">hex</code> file in default path <code class="language-plaintext highlighter-rouge">"..\project.X\dist\project\production"</code> and generate <code class="language-plaintext highlighter-rouge">bin</code> file .</li> </ul> </li> <li> <p>User may also execute post build command <code class="language-plaintext highlighter-rouge">../../tools/hex2bin/hex2bin.exe</code> from MPLABx project itself :</p> <ul> <li> <ul> <li>Right click on the project and click on properties.</li> </ul> <p><img src="../../../system/ota/docs/images/project_loading.PNG" alt="imageloading" /></p> </li> <li> <p>Select “building”, insert below command and click “OK”:</p> <p><code class="language-plaintext highlighter-rouge">../../tools/hex2bin/hex2bin.exe </code></p> <p><strong>Note</strong>: python should be present in the system variable path.</p> <p><img src="../../../system/ota/docs/images/post_build.png" alt="postbuild" /></p> </li> </ul> </li> </ul> <h2 id="ota-server"> <a href="#ota-server" aria-labelledby="ota-server" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> OTA server: </h2> <p>Any standard http/https server can be used as OTA server as long as it hosts a manifest file with the mandatory fields.</p> <ul> <li> <p>For testing the service, you may also use a simple python command to create a local <strong>HTTP</strong> server using below steps:</p> <ul> <li> <p>Open command prompt and change directory to the folder where json file/ota image is present.</p> <p><img src="../../../system/ota/docs/images/Change_dir.PNG" alt="directory" /></p> </li> <li> <p>Use below python command in command prompt:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHTTPServer</span> <span class="mi">8000</span>
</code></pre></div> </div> <p><img src="../../../system/ota/docs/images/http_server.PNG" alt="server" /></p> </li> </ul> </li> </ul> <h2 id="integrating-bootloader"> <a href="#integrating-bootloader" aria-labelledby="integrating-bootloader" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Integrating bootloader </h2> <p>It is required to integrate the bootloader and OTA application image to create a single unified HEX file. To integrate 2 images we can use hexmate tool, which is readily available with MPLABX package as part of the standard installation. To combine the hex files - please follow steps mentioned in configuration page : <a href="../../../system/ota/docs/configuration.html#configuring-the-library">Configuring the library</a></p> <h2 id="resolving-data-conflict--compilation-error"> <a href="#resolving-data-conflict--compilation-error" aria-labelledby="resolving-data-conflict--compilation-error" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Resolving <code class="language-plaintext highlighter-rouge">Data Conflict </code> Compilation error </h2> <p>During compilation if user is facing <code class="language-plaintext highlighter-rouge">Data conflict at address..</code> compilation error , please check if there is any mismatch of configuration ( <code class="language-plaintext highlighter-rouge">#pragma </code>) between bootloader and application. User may simply compare <code class="language-plaintext highlighter-rouge">initialization.c</code> files of both the projects to check mismatch.</p> <p><img src="images/pragma_mismatch.PNG" alt="" /></p> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0"><img src='https://raw.githubusercontent.com/wiki/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/images/microchip_logo.png' /><br />Copyright &copy; 2020 Microchip Technology.</p> <!-- <p class="text-small text-grey-dk-000 mb-0"><img src='../../../assets/images/vendor/microchip_logo.png' /><br /> Copyright &copy; 2021 Microchip Technology.</p> --> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
